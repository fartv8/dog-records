<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dog Records</title>
  <style>
    :root {
      --bg:#f5f5f5; --text:#333; --muted:#666; --line:#ddd; --brand:#4caf50;
      --card:#fff; --shadow:0 2px 4px rgba(0,0,0,.1);
    }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    h1 { text-align: center; margin: 0 0 10px; }
    .sub { text-align:center; color:var(--muted); margin-bottom:16px; }

    /* FORM */
    form {
      display: grid; gap: 8px;
      max-width: 900px; margin: 0 auto 20px; background: var(--card);
      padding: 16px; border-radius: 8px; box-shadow: var(--shadow);
      grid-template-columns: repeat(3, 1fr);
    }
    form input, form textarea, form button {
      padding: 10px; border:1px solid var(--line); border-radius:6px; font-size:14px;
    }
    form textarea { grid-column: span 3; min-height: 70px; }
    .checks { grid-column: span 3; display:flex; gap:16px; flex-wrap:wrap; }
    .checks label { display:flex; align-items:center; gap:6px; }
    .row-3 { grid-column: span 3; }
    .row-2 { grid-column: span 2; }
    .btn-primary { background:var(--brand); color:#fff; border:none; cursor:pointer; }

    /* SEARCH + REPORT */
    .search-bar, .report-bar {
      max-width: 900px; margin: 0 auto 10px; display:flex; gap:10px; align-items:center;
    }
    .search-bar input, .report-bar input { flex:1; padding:10px; border:1px solid var(--line); border-radius:6px; }
    .print-btn { padding:10px 16px; border:none; background:var(--brand); color:#fff; border-radius:6px; cursor:pointer; }

    /* APPTS */
    .schedule {
      max-width: 900px; margin: 16px auto; background: var(--card);
      border-radius: 8px; box-shadow: var(--shadow); padding: 16px;
    }
    .appt-item {
      display:flex; justify-content:space-between; align-items:center;
      border:1px solid #eee; padding:10px 12px; border-radius:8px; margin:8px 0;
    }

    /* TABLE */
    table {
      width: 100%; max-width: 1200px; margin: 16px auto 0;
      border-collapse: collapse; background: var(--card); box-shadow: var(--shadow);
    }
    th, td { border:1px solid var(--line); padding: 10px; text-align:left; vertical-align:top; font-size:14px; }
    th { background: var(--brand); color:#fff; position: sticky; top: 0; }
    tr:nth-child(even) { background: #f7f7f7; }
    .action-buttons { display:flex; gap:6px; flex-wrap:wrap; }
    .btn { padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:6px; cursor:pointer; }
    .btn.save { background: #4caf50; color:#fff; border:none; }
    .btn.cancel { background: #6c757d; color:#fff; border:none; }
    .btn.delete { background: #dc3545; color:#fff; border:none; }
    .btn.small { padding:6px 10px; }
    .timestamp { display:block; font-size:.85em; color:var(--muted); margin-top:4px; }
    td[contenteditable="true"] { outline: 2px dashed #ffd54f; background:#fffbe6; }
  </style>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Dog Records</h1>
  <div class="sub">Real-time check-ins, appointments, inline editing, and printable owner reports</div>

  <!-- FORM -->
  <form id="dogForm" autocomplete="off">
    <input type="text" id="dogName" placeholder="Dog Name" required>
    <input type="text" id="ownerName" placeholder="Owner Name" required>
    <input type="text" id="breed" placeholder="Breed" required>

    <label style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" id="sn"> S/N
    </label>
    <input type="datetime-local" id="appointment" placeholder="Appointment Date & Time">
    <input type="text" id="city" placeholder="City">

    <textarea id="description" class="row-3" placeholder="Grooming Supplies / Instructions"></textarea>

    <div class="checks">
      <label><input type="checkbox" id="vaccinated"> Vaccinated</label>
      <label><input type="checkbox" id="cologne"> Cologne</label>
    </div>

    <input type="text" id="specialGrooming" class="row-2" placeholder="Bathing Instructions (optional)">
    <input type="text" id="state" placeholder="State">
    <input type="text" id="zip" placeholder="Zip Code">
    <input type="text" id="veterinarian" class="row-3" placeholder="Veterinarian">

    <button type="submit" class="btn-primary row-3">Add Dog</button>
  </form>

  <!-- SEARCH -->
  <div class="search-bar">
    <input type="text" id="searchDog" placeholder="Search by dog name" oninput="filterTable()">
    <input type="text" id="searchOwner" placeholder="Search by owner name" oninput="filterTable()">
  </div>

  <!-- REPORT -->
  <div class="report-bar">
    <input type="text" id="ownerFilter" placeholder="Enter owner name to print report">
    <button class="print-btn" onclick="printReport()">Print Owner Report</button>
  </div>

  <!-- UPCOMING APPOINTMENTS -->
  <div class="schedule">
    <h2>Upcoming Appointments</h2>
    <div id="appointmentsList"></div>
  </div>

  <!-- TABLE -->
  <table>
    <thead>
      <tr>
        <th>Dog Name</th>
        <th>Owner</th>
        <th>Breed</th>
        <th>S/N</th>
        <th>Grooming Supplies</th>
        <th>Vaccinated</th>
        <th>Cologne</th>
        <th>Bathing Instructions</th>
        <th>City</th>
        <th>State</th>
        <th>Zip</th>
        <th>Veterinarian</th>
        <th>Appointment</th>
        <th>Check In</th>
        <th>Check Out</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="dogTableBody"></tbody>
  </table>

  <script>
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBLFMBvc4HF9atMxzY7Rf1u-oBJBAYZvTo",
      authDomain: "dog-records-656c0.firebaseapp.com",
      databaseURL: "https://dog-records-656c0-default-rtdb.firebaseio.com",
      projectId: "dog-records-656c0",
      storageBucket: "dog-records-656c0.appspot.com",
      messagingSenderId: "347010811100",
      appId: "1:347010811100:web:e32d9e95f860b2d16fa019"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- DOM ---
    const form = document.getElementById('dogForm');
    const tableBody = document.getElementById('dogTableBody');
    const appointmentsList = document.getElementById('appointmentsList');
    const ownerFilterInput = document.getElementById('ownerFilter');
    const searchDogInput = document.getElementById('searchDog');
    const searchOwnerInput = document.getElementById('searchOwner');

    let allRows = [];

    // --- Helpers ---
    function esc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Build a table row with edit/save/cancel/delete
    function addDogToTable(dog, id) {
      const row = document.createElement('tr');
      row.setAttribute('data-id', id);
      row.innerHTML = `
        <td class="c0" contenteditable="false">${esc(dog.name)}</td>
        <td class="c1" contenteditable="false">${esc(dog.owner)}</td>
        <td class="c2" contenteditable="false">${esc(dog.breed)}</td>
        <td class="c3" contenteditable="false">${dog.sn ? 'Yes' : 'No'}</td>
        <td class="c4" contenteditable="false">${esc(dog.description)}</td>
        <td class="c5" contenteditable="false">${dog.vaccinated ? 'Yes' : 'No'}</td>
        <td class="c6" contenteditable="false">${dog.cologne ? 'Yes' : 'No'}</td>
        <td class="c7" contenteditable="false">${esc(dog.specialGrooming)}</td>
        <td class="c8" contenteditable="false">${esc(dog.city)}</td>
        <td class="c9" contenteditable="false">${esc(dog.state)}</td>
        <td class="c10" contenteditable="false">${esc(dog.zip)}</td>
        <td class="c11" contenteditable="false">${esc(dog.veterinarian)}</td>
        <td class="c12" contenteditable="false">${esc(dog.appointment)}</td>

        <td>
          <button class="btn small" onclick="checkIn('${id}')">Check In</button>
          <span class="timestamp">${esc(dog.checkIn)}</span>
        </td>
        <td>
          <button class="btn small" onclick="checkOut('${id}')">Check Out</button>
          <span class="timestamp">${esc(dog.checkOut)}</span>
        </td>
        <td class="action-buttons">
          <button class="btn edit">Edit</button>
          <button class="btn save" style="display:none;">Save</button>
          <button class="btn cancel" style="display:none;">Cancel</button>
          <button class="btn delete">Delete</button>
        </td>
      `;
      // wire actions
      const editBtn = row.querySelector('.edit');
      const saveBtn = row.querySelector('.save');
      const cancelBtn = row.querySelector('.cancel');
      const delBtn = row.querySelector('.delete');

      editBtn.addEventListener('click', () => enterEdit(row));
      cancelBtn.addEventListener('click', () => exitEdit(row, true));
      saveBtn.addEventListener('click', () => saveRow(row, id));
      delBtn.addEventListener('click', () => deleteDog(id));

      allRows.push(row);
      tableBody.appendChild(row);
    }

    // Enter edit mode
    function enterEdit(row){
      // mark which cells are editable (not checkin/checkout/actions)
      for(let i=0;i<=12;i++){
        const cell=row.querySelector(`.c${i}`);
        if(!cell) continue;
        cell.setAttribute('data-original', cell.textContent);
        cell.contentEditable = "true";
      }
      row.querySelector('.edit').style.display='none';
      row.querySelector('.save').style.display='inline-block';
      row.querySelector('.cancel').style.display='inline-block';
    }

    // Exit edit mode (cancel = true -> restore)
    function exitEdit(row, cancel=false){
      for(let i=0;i<=12;i++){
        const cell=row.querySelector(`.c${i}`);
        if(!cell) continue;
        if(cancel){
          const orig = cell.getAttribute('data-original') || '';
          cell.textContent = orig;
        }
        cell.removeAttribute('data-original');
        cell.contentEditable = "false";
      }
      row.querySelector('.edit').style.display='inline-block';
      row.querySelector('.save').style.display='none';
      row.querySelector('.cancel').style.display='none';
    }

    // Save to Firebase
    function saveRow(row, id){
      const cells = row.querySelectorAll('td');
      const updated = {
        name: cells[0].textContent.trim(),
        owner: cells[1].textContent.trim(),
        breed: cells[2].textContent.trim(),
        sn: cells[3].textContent.trim().toLowerCase()==='yes',
        description: cells[4].textContent.trim(),
        vaccinated: cells[5].textContent.trim().toLowerCase()==='yes',
        cologne: cells[6].textContent.trim().toLowerCase()==='yes',
        specialGrooming: cells[7].textContent.trim(),
        city: cells[8].textContent.trim(),
        state: cells[9].textContent.trim(),
        zip: cells[10].textContent.trim(),
        veterinarian: cells[11].textContent.trim(),
        appointment: cells[12].textContent.trim(),
        checkIn: row.querySelectorAll('.timestamp')[0]?.textContent || '',
        checkOut: row.querySelectorAll('.timestamp')[1]?.textContent || ''
      };
      db.ref('dogs/'+id).set(updated)
        .then(()=> exitEdit(row, false))
        .catch(err=> alert('Save failed: ' + err.message));
    }

    // Check-in/out/delete
    function deleteDog(id){
      if(confirm('Delete this record?')){
        db.ref('dogs/'+id).remove();
      }
    }
    window.checkIn = id => db.ref('dogs/'+id+'/checkIn').set(new Date().toLocaleString());
    window.checkOut = id => db.ref('dogs/'+id+'/checkOut').set(new Date().toLocaleString());

    // Search filter
    window.filterTable = function(){
      const d = (searchDogInput.value||'').toLowerCase();
      const o = (searchOwnerInput.value||'').toLowerCase();
      tableBody.innerHTML = '';
      allRows.forEach(r=>{
        const dog = r.children[0].textContent.toLowerCase();
        const owner = r.children[1].textContent.toLowerCase();
        if(dog.includes(d) && owner.includes(o)) tableBody.appendChild(r);
      });
    };

    // Owner report printer
    window.printReport = function(){
      const owner = (ownerFilterInput.value||'').trim().toLowerCase();
      if(!owner) return alert('Enter owner name');
      const rows = allRows.filter(r => r.children[1].textContent.trim().toLowerCase() === owner);
      if(!rows.length) return alert('No records for: ' + owner);

      let html = `
        <html><head><title>Owner Report - ${owner}</title>
        <style>
          body{font-family:Arial,sans-serif;padding:20px;background:#f5f5f5;}
          h2{text-align:center;margin-bottom:20px;color:#333;text-transform:capitalize;}
          table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);}
          th,td{padding:10px;border:1px solid #ddd;text-align:left}
          th{background:#4caf50;color:#fff;}
          tr:nth-child(even){background:#f7f7f7;}
        </style>
        </head><body>
        <h2>Dog Records for Owner: ${owner}</h2>
        <table>
          <thead>
            <tr>
              <th>Dog Name</th><th>Owner</th><th>Breed</th><th>S/N</th>
              <th>Grooming Supplies</th><th>Vaccinated</th><th>Cologne</th>
              <th>Bathing Instructions</th><th>City</th><th>State</th><th>Zip</th>
              <th>Veterinarian</th><th>Appointment</th><th>Check In</th><th>Check Out</th>
            </tr>
          </thead><tbody>
      `;
      rows.forEach(r=>{
        const c = r.querySelectorAll('td');
        html += `
          <tr>
            <td>${c[0].textContent}</td>
            <td>${c[1].textContent}</td>
            <td>${c[2].textContent}</td>
            <td>${c[3].textContent}</td>
            <td>${c[4].textContent}</td>
            <td>${c[5].textContent}</td>
            <td>${c[6].textContent}</td>
            <td>${c[7].textContent}</td>
            <td>${c[8].textContent}</td>
            <td>${c[9].textContent}</td>
            <td>${c[10].textContent}</td>
            <td>${c[11].textContent}</td>
            <td>${c[12].textContent}</td>
            <td>${c[13].querySelector('.timestamp')?.textContent || ''}</td>
            <td>${c[14].querySelector('.timestamp')?.textContent || ''}</td>
          </tr>`;
      });
      html += `</tbody></table></body></html>`;
      const w = window.open('', '_blank', 'width=1100,height=800');
      w.document.write(html); w.document.close(); w.focus(); w.print();
    };

    // Render appointments list
    function renderAppointments(dogsObj){
      const items = [];
      for(const [id,d] of Object.entries(dogsObj||{})){
        if(!d.appointment) continue;
        const ts = new Date(d.appointment).getTime();
        if(isNaN(ts)) continue;
        items.push({ id, ts, name:d.name||'', owner:d.owner||'', breed:d.breed||'', when:d.appointment });
      }
      items.sort((a,b)=>a.ts-b.ts);
      if(!items.length){ appointmentsList.innerHTML = `<div style="color:#666">No upcoming appointments.</div>`; return; }
      appointmentsList.innerHTML = items.map(x=>`
        <div class="appt-item">
          <div>
            <div><strong>${new Date(x.when).toLocaleString()}</strong></div>
            <div>${esc(x.name)} (${esc(x.breed)}) â€¢ Owner: <strong>${esc(x.owner)}</strong></div>
            <div style="font-size:12px;color:#666;">Dog ID: ${esc(x.id)}</div>
          </div>
          <div><button class="btn small" onclick="checkIn('${x.id}')">Mark Arrived</button></div>
        </div>
      `).join('');
    }

    // Realtime sync
    function loadDogs(){
      db.ref('dogs').on('value', snap=>{
        tableBody.innerHTML=''; allRows=[];
        const dogs = snap.val()||{};
        Object.entries(dogs).forEach(([id,d])=> addDogToTable(d,id));
        renderAppointments(dogs);
        filterTable(); // keep filters applied
      });
    }

    // Add new dog
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const data = {
        name: dogName.value.trim(),
        owner: ownerName.value.trim(),
        breed: breed.value.trim(),
        sn: sn.checked,
        appointment: appointment.value.trim(),
        description: description.value.trim(),
        vaccinated: vaccinated.checked,
        cologne: cologne.checked,
        specialGrooming: specialGrooming.value.trim(),
        city: city.value.trim(),
        state: state.value.trim(),
        zip: zip.value.trim(),
        veterinarian: veterinarian.value.trim(),
        checkIn: '', checkOut: ''
      };
      if(!data.name || !data.owner || !data.breed){
        alert('Please fill out Dog Name, Owner Name, and Breed.');
        return;
      }
      db.ref('dogs').push().set(data).then(()=> form.reset());
    });

    loadDogs();
  </script>
</body>
</html>
